#  切图机 后台通讯方案

### 1. 概况
> * 切图机推送原始图信息和切图信息到后台
> * 切图机允许后台服务发送切图指令并予以执行
> * 切图机允许后台服务监控忙碌状态 <忙碌|空闲>
> * 切图机切图完成添加Slide.ini文件和更新Torch图目录名命名规则

### 2. 通讯过程
> - **数据格式:** JSON
> - **连接方式:** Socket
![avatar](/Users/bowen/Desktop/slied_sms.png)

### 3. 需求
> #### **2.1 原始图消息**
> - **请求参数:** 
```json
    {
        "Type": "ScanFile",
        "Data": {
            "SampleCode": "样本编号",
            "FilePath": "20200812/211252B541222_123350/",
        }
    }
```
> - **返回参数:** 
```json
    {
        "Success": 1,   # 成功 = 1 |  失败 = 0
        "Msg": "消息 成功返回空"
    }
```
> #### **2.2 切图完成消息**
> - **请求参数:** 
```json
    {
        "Type": "CutawayFile",
        "Data": {
            "SampleCode": "样本编号",
            "FilePath": "20200812/211252B541222_20/",
            "SlideType": 20,  # 9层图 = 1,   10倍图 = 10, 20倍图 = 20
            "SampleSource": "211252B541222_123350"  # 原始图文件名
            
        }
    }
```
> - **返回参数:** 
```json
    {
        "Success": 1,   # 成功 = 1 |  失败 = 0
        "Msg": "消息 成功返回空"
    }
```
> #### **2.3 接收切图指令消息**
> - **说明:** 切图机收到后台发送的切图指令执行切图任务
> - **请求参数:** 
```json
    {
        "Type": "CutawayTask",
        "Data": {
            "SampleCode": "样本编号",
            "FilePath": "20200812/211252B541222_123350/",
            "SlideType": "切图类型"  # 9层图 = 1,   10倍图 = 10, 20倍图 = 20
        }
    }
```
> #### **2.4 切图机运行状态**
> - **请求参数:** 
```json
    {
        "Type": "Status"
    }
```
> - **返回参数:** 
```json
    {
        "Success": 1,   # 成功 = 1  |  失败 = 0
        "Status": 0,    # 空闲 = 0  |  忙碌 = 1
        "Msg": "消息 成功返回空"
    }
```
> #### **2.5 切图机保存文件**
```note
    1, 文件夹的格式由原来的样本编号命名修改为 样本编号_倍率  示例：211252B541222_20
    2, Torch图Slide文件必要的参数包含： 1，使用的原始图文件名   2，切图的类型 10倍&20倍&九层图  3，切图时间 
```
> #### **2.6 提供Python文件执行入口**
```note
    1, 在切图机开始执行切图之前调用一个Python脚本，与切图完成调用的Python功能一样（现在有的功能）。
    
```
> #### **2.6 其它**
```node
    1，消息推送到后台需要有log记录
    2，如果后台Socket未连接或连接失败需要将推送的消息的内容记录到文本
    3，如果消息推送返回参数success = 0, 需要将推送的消息和返回的消息记录到文本
```
